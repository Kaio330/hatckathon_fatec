<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Chamados - Painel do Aluno</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="main-page">

  <header>
    <div class="header-content">
      <div class="logo">üìò</div>
      <div>
        <h1>Meu Painel de Chamados</h1>
        <p id="studentEmail"></p>
      </div>
    </div>
    <button class="logout-btn" id="logoutBtn">Sair</button>
  </header>

  <section class="cards">
    <div class="card">
      <div class="card-info">
        <p>Total de Chamados</p>
        <strong id="total">0</strong>
      </div>
      <div class="card-icon total-icon"><i data-feather="file-text"></i></div>
    </div>
    <div class="card">
      <div class="card-info">
        <p>Abertos</p>
        <strong id="abertos">0</strong>
      </div>
      <div class="card-icon abertos-icon"><i data-feather="alert-circle"></i></div>
    </div>
    <div class="card">
      <div class="card-info">
        <p>Em Andamento</p>
        <strong id="andamento">0</strong>
      </div>
      <div class="card-icon andamento-icon"><i data-feather="clock"></i></div>
    </div>
    <div class="card">
      <div class="card-info">
        <p>Resolvidos</p>
        <strong id="resolvidos">0</strong>
      </div>
      <div class="card-icon resolvidos-icon"><i data-feather="check-circle"></i></div>
    </div>
  </section>

  <button class="btn" id="novoChamadoBtn">+ Abrir Novo Chamado</button>

  <section class="section">
    <h2>Meus Chamados</h2>

    <div class="filters">
      <select id="filterStatus">
        <option value="todos">Todos os Status</option>
        <option value="Aberto">Aberto</option>
        <option value="Em Andamento">Em Andamento</option>
        <option value="Resolvido">Resolvido</option>
      </select>

      <select id="filterCategoria">
        <option value="todas">Todas as Categorias</option>
        <option value="Rede">Rede</option>
        <option value="Hardware">Hardware</option>
        <option value="Software">Software</option>
        <option value="El√©trica">El√©trica</option>
        <option value="Hidr√°ulica">Hidr√°ulica</option>
        <option value="Climatiza√ß√£o">Climatiza√ß√£o</option>
      </select>
    </div>

    <div id="listaChamados" class="empty">
      Voc√™ ainda n√£o abriu nenhum chamado.
    </div>
  </section>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitulo">Novo Chamado</h3>
      <input type="text" id="titulo" placeholder="T√≠tulo do chamado" required>
      <textarea id="descricao" placeholder="Descri√ß√£o detalhada"></textarea>
      <input type="text" id="local" placeholder="Local (ex: Bloco A - 3¬∫ andar)">
      <select id="categoria">
        <option value="Rede">Rede</option>
        <option value="Hardware">Hardware</option>
        <option value="Software">Software</option>
        <option value="El√©trica">El√©trica</option>
        <option value="Hidr√°ulica">Hidr√°ulica</option>
        <option value="Climatiza√ß√£o">Climatiza√ß√£o</option>
      </select>
      <label for="anexo" style="text-align: left; margin-top: 1rem;">Anexar Imagem (Opcional)</label>
      <input type="file" id="anexo" accept="image/*">
      <div class="modal-buttons">
        <button class="cancel" id="cancelar">Cancelar</button>
        <button class="save" id="salvar">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <span class="close-image-modal">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <script>
    const modal = document.getElementById('modal');
    const lista = document.getElementById('listaChamados');
    const total = document.getElementById('total');
    const abertos = document.getElementById('abertos');
    const andamento = document.getElementById('andamento');
    const resolvidos = document.getElementById('resolvidos');
    const salvarBtn = document.getElementById('salvar');
    const modalTitulo = document.getElementById('modalTitulo');
    const studentEmailEl = document.getElementById('studentEmail');

    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModal = document.querySelector('.close-image-modal');

    let chamados = [];
    const currentUserEmail = localStorage.getItem('currentUser');
    if (!currentUserEmail) {
        window.location.href = 'home.html';
    } else {
        studentEmailEl.textContent = `Logado como: ${currentUserEmail}`;
    }

    function salvarChamados() {
      localStorage.setItem('chamados', JSON.stringify(chamados));
    }

    function carregarChamados() {
      const salvos = localStorage.getItem('chamados');
      if (salvos) {
        chamados = JSON.parse(salvos);
        atualizarChamados();
      }
    }

    document.getElementById('novoChamadoBtn').onclick = () => {
      modal.style.display = 'flex';
      modalTitulo.textContent = "Novo Chamado";
      document.querySelectorAll('#modal input, #modal textarea, #modal select').forEach(e => e.value = '');
    };
    document.getElementById('cancelar').onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    salvarBtn.onclick = () => {
      const titulo = document.getElementById('titulo').value;
      const descricao = document.getElementById('descricao').value;
      const local = document.getElementById('local').value;
      const categoria = document.getElementById('categoria').value;
      const anexoInput = document.getElementById('anexo');
      const anexoFile = anexoInput.files[0];

      if (!titulo) return alert('Informe o t√≠tulo do chamado!');

      const salvarChamadoNoSistema = (anexoBase64 = null) => {
        const chamado = {
          titulo, descricao, local, categoria,
          prioridade: 'N√£o definida', // Prioridade padr√£o
          status: 'Aberto', // Status padr√£o
          criador: currentUserEmail,
          anexo: anexoBase64,
          data: new Date().toLocaleString()
        };

        chamados.push(chamado);
        salvarChamados();
        modal.style.display = 'none';
        atualizarChamados();
        anexoInput.value = '';
      };

      if (anexoFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
          salvarChamadoNoSistema(e.target.result);
        };
        reader.readAsDataURL(anexoFile);
      } else {
        salvarChamadoNoSistema(null);
      }
    };

    function atualizarChamados() {
      lista.innerHTML = "";
      const fs = document.getElementById('filterStatus').value;
      const fc = document.getElementById('filterCategoria').value;

      const meusChamados = chamados.filter(c => c.criador === currentUserEmail);

      const filtrados = meusChamados.filter(c =>
        (fs === "todos" || c.status === fs) &&
        (fc === "todas" || c.categoria === fc)
      );

      if (filtrados.length === 0) {
        lista.className = "empty";
        lista.textContent = "Nenhum chamado encontrado com os filtros selecionados.";
      } else {
        lista.className = "";
        filtrados.forEach((c, globalIndex) => {
          const div = document.createElement("div");
          div.className = "chamado";
          const anexoHtml = c.anexo ? `<img src="${c.anexo}" alt="Anexo" class="chamado-anexo">` : '';

          div.innerHTML = `
            <div class="chamado-header">
              <span><strong>#${globalIndex + 1}</strong></span>
              <span class="status ${c.status.replace(' ', '')}">${c.status}</span>
            </div>
            <strong>${c.titulo}</strong>
            <p class="descricao">${c.descricao || "‚Äî"}</p>
            ${anexoHtml}
            <div class="detalhes">
              <span>üìç ${c.local || "Local n√£o informado"}</span>
              <span>‚öôÔ∏è ${c.categoria}</span>
              <span>‚ö†Ô∏è ${c.prioridade}</span>
              <span>‚è∞ ${c.data}</span>
            </div>
            <p class="criador">Criado por: Voc√™</p>
          `;
          lista.appendChild(div);
        });
      }

      total.textContent = meusChamados.length;
      abertos.textContent = meusChamados.filter(c => c.status === "Aberto").length;
      andamento.textContent = meusChamados.filter(c => c.status === "Em Andamento").length;
      resolvidos.textContent = meusChamados.filter(c => c.status === "Resolvido").length;
    }

    document.getElementById('filterStatus').onchange = atualizarChamados;
    document.getElementById('filterCategoria').onchange = atualizarChamados;

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'home.html';
    });

    // --- L√≥gica do Modal de Imagem ---
    lista.addEventListener('click', function(e) {
      if (e.target.classList.contains('chamado-anexo')) {
        imageModal.style.display = 'flex';
        modalImage.src = e.target.src;
      }
    });

    closeImageModal.onclick = function() {
      imageModal.style.display = 'none';
    }

    carregarChamados();

    feather.replace();
  </script>
</body>
</html>
